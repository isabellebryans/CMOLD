@prefix rdf:  <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix xs:   <http://www.w3.org/2001/XMLSchema#> .
@prefix : <http://example.org/>.
@prefix sh: <http://www.w3.org/ns/shacl#>.

:MoveDiagonal
    a sh:NodeShape ;

    sh:sparql [ a           sh:SPARQLConstraint ;
                sh:message  "Invalid move: not on same row." ;
                sh:prefixes [ sh:declare [ sh:prefix    "" ;
                                           sh:namespace "http://example.org/"^^xs:anyURI ; ] ;
                              sh:declare [ sh:prefix "rdf" ;
                                           sh:namespace
                                                     "http://www.w3.org/1999/02/22-rdf-syntax-ns#"^^xs:anyURI ; ];
                              sh:declare [ sh:prefix "xsd" ;
                                           sh:namespace
                                                     "http://www.w3.org/2001/XMLSchema#"^^xs:anyURI ; ]] ;
                sh:select   """
      SELECT $this
      WHERE {
        $this :isIn ?current ;
              :to ?target .
        ?current :row ?row1;
            :column ?col1.
        ?target :row ?row2;
            :column ?col2.
        BIND(xsd:integer(str(?row1)) AS ?intRow1)
        BIND(xsd:integer(str(?row2)) AS ?intRow2)
        BIND(ABS(?intRow1 - ?intRow2) AS ?rowDiff)
        BIND(ABS(xsd:integer(xsd:char(?col1)) - xsd:integer(xsd:char(?col2))) AS ?colDiff)
        FILTER (?rowDiff = ?colDiff || ?current = ?target)
      }
    """ ]
   .

:MoveRule a sh:NodeShape ;
          sh:targetSubjectsOf :to ;
          sh:sparql [ a           sh:SPARQLConstraint ;
                      sh:message  "Invalid move: not on same row." ;
                      sh:prefixes [ sh:declare [ sh:prefix    "" ;
                                                 sh:namespace "http://example.org/"^^xs:anyURI ; ] ;
                                    sh:declare [ sh:prefix "rdf" ;
                                                 sh:namespace
                                                           "http://www.w3.org/1999/02/22-rdf-syntax-ns#"^^xs:anyURI ; ] ] ;
                      sh:select   """
      SELECT $this
      WHERE {
        $this :isIn ?current ;
              :to ?target .
        ?current :row ?row1.
        ?target :row ?row2.
        FILTER (?row1 != ?row2)
      }
    """ ];
          sh:or ( [ sh:sparql [ a           sh:SPARQLConstraint ;
                                  sh:message  "Invalid move: overtaking is not allowed." ;
                                  sh:prefixes [ sh:declare [ sh:prefix    "" ;
                                                             sh:namespace "http://example.org/"^^xs:anyURI ; ] ;
                                                sh:declare [ sh:prefix "rdf" ;
                                                             sh:namespace
                                                                       "http://www.w3.org/1999/02/22-rdf-syntax-ns#"^^xs:anyURI ; ] ] ;
                                  sh:select   """
      SELECT $this ?current ?target ?intermediate
      WHERE {
        $this :isIn ?current ;
              :to ?target .
        ?piece2 rdf:type :ChessPiece.
        ?piece2 :isIn ?tile.
        ?current :right+ ?intermediate .
        ?intermediate :right* ?target .
        FILTER ($this != ?piece2 && ?tile = ?intermediate)
      }
    """ ]
                    ]
                    [
                        sh:sparql [
                                      a           sh:SPARQLConstraint ;
                                    sh:message  "Invalid move: overtaking is not allowed." ;
                                    sh:prefixes [ sh:declare [ sh:prefix    "" ;
                                                               sh:namespace "http://example.org/"^^xs:anyURI ; ] ;
                                                  sh:declare [ sh:prefix "rdf" ;
                                                               sh:namespace
                                                                         "http://www.w3.org/1999/02/22-rdf-syntax-ns#"^^xs:anyURI ; ] ] ;
                                    sh:select   """
      SELECT $this ?current ?target ?intermediate
      WHERE {
        $this :isIn ?current ;
              :to ?target .
        ?piece2 rdf:type :ChessPiece.
        ?piece2 :isIn ?tile.
        ?current :left+ ?intermediate .
        ?intermediate :left* ?target .
        FILTER ($this != ?piece2 && ?tile = ?intermediate)
      }
    """ ]
                    ] ).

